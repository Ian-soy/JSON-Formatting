<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON格式化大师</title>
  <link rel="stylesheet" href="src/css/popup.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>JSON格式化大师</h1>
      <div class="header-actions">
        <button id="settings-btn" class="btn secondary"><span class="icon-container"></span></button>
      </div>
    </div>
    
    <div class="toolbar">
      <button id="format-btn" class="btn primary" title="格式化JSON"><span class="icon-container"></span></button>
      <button id="minify-btn" class="btn secondary" title="压缩JSON"><span class="icon-container"></span></button>

      <button id="copy-btn" class="btn secondary" title="复制到剪贴板"><span class="icon-container"></span></button>
      <button id="download-btn" class="btn secondary" title="下载JSON文件"><span class="icon-container"></span></button>
      <button id="save-btn" class="btn secondary" title="保存JSON数据"><span class="icon-container"></span></button>
      <button id="convert-btn" class="btn secondary" title="格式转换"><span class="icon-container"></span></button>
      <button id="share-btn" class="btn secondary" title="分享JSON"><span class="icon-container"></span></button>
      <button id="to-api-btn" class="btn secondary" title="转为API服务"><span class="icon-container"></span></button>
    </div>
    
    <!-- 主要内容区域：左右布局 -->
    <div class="main-content">
      <!-- 左侧：编辑器区域 -->
      <div class="editor-section">
        <div class="editor-container">
          <div class="line-numbers" id="line-numbers"></div>
          <textarea id="json-input" placeholder="在此粘贴JSON数据或者分享的数据地址..."></textarea>
        </div>
      </div>
      
      <!-- 右侧：历史数据面板 -->
      <div class="history-section" id="history-section">
        <!-- 展开/折叠按钮 -->
        <div class="history-toggle-btn" id="history-toggle-btn" title="折叠历史面板">
          <span class="icon-container"></span>
        </div>
        <div class="history-header">
          <h3>历史数据</h3>
          <button id="refresh-history-btn" class="btn secondary"><span class="icon-container"></span></button>
        </div>
        <div class="history-list" id="history-list">
          <div class="no-data">暂无保存的数据</div>
        </div>
      </div>
    </div>
    
    <div class="status-bar">
      <span id="status-message">准备就绪</span>
      <span id="char-count">0 字符</span>
    </div>
    
    <div id="api-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>浏览器原生API服务</h2>
        
        <!-- 模态框内部提示区域 -->
        <div id="api-modal-message" class="modal-message" style="display: none;"></div>
        
        <div class="api-info">
          <p>API服务器状态: <span id="api-status">未启动</span></p>
          <div class="api-controls">
            <button id="start-api-btn" class="btn primary">启动API服务</button>
            <button id="stop-api-btn" class="btn secondary" disabled>停止API服务</button>
          </div>
        </div>
        
        <div class="api-endpoint">
          <p>服务类型:</p>
          <span id="api-url">浏览器原生API (Service Worker)</span>
          <div class="btn-group">
            <button id="copy-api-url" class="btn secondary">复制使用说明</button>
            <button id="open-api-docs" class="btn secondary">打开API文档</button>
          </div>
        </div>
        
        <!-- API调试工具区域 -->
        <div class="api-debug-tools">
          <h4>浏览器原生API调试</h4>
          <div class="debug-btn-group">
            <button id="test-api-connection" class="btn secondary small" onclick="testServiceWorkerApi()" title="测试Service Worker API连接">🔍 连接测试</button>
            <button id="switch-api-provider" class="btn secondary small" onclick="switchToMemoryApi()" title="切换到备用API提供者">🔄 切换备用</button>
            <button id="show-api-info" class="btn secondary small" onclick="showApiProviderInfo()" title="显示当前API提供者详细信息">📊 提供者信息</button>
          </div>
          <div class="api-help">
            <p><strong>浏览器原生API特性：</strong></p>
            <ul>
              <li>零依赖启动，无需安装Python或Node.js</li>
              <li>基于Service Worker，响应速度极快</li>
              <li>内置缓存机制，提升性能</li>
              <li>支持多提供者自动切换</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <div id="share-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>分享JSON数据</h2>
        
        <!-- 模态框内部提示区域 -->
        <div id="share-modal-message" class="modal-message" style="display: none;"></div>
        
        <div class="share-options">
          <input type="text" id="share-link" readonly>
          <button id="copy-share-link" class="btn primary">复制链接</button>
        </div>
        <!-- 分享统计信息 -->
        <div id="share-stats-container" class="share-stats-container"></div>
        <div class="share-help">
          <p><strong>使用说明：</strong></p>
          <ul>
            <li>复制分享链接发送给他人</li>
            <li>直接在编辑器中粘贴分享链接即可自动导入JSON</li>
            <li>支持智能分级压缩：小数据保持原始，大数据自动高效压缩</li>
            <li>极大JSON数据使用最大压缩算法，最多可节省70%空间</li>
            <li>支持缓存机制，重复分享相同数据更快速</li>
          </ul>
        </div>
      </div>
    </div>
    
    <div id="convert-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>格式转换</h2>
        <div class="convert-options">
          <button id="to-xml-btn" class="btn secondary">转换为XML</button>
          <button id="to-csv-btn" class="btn secondary">转换为CSV</button>
        </div>
      </div>
    </div>
    
    <!-- 保存模态框 -->
    <div id="save-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>保存JSON数据</h2>
        
        <!-- 模态框内部提示区域 -->
        <div id="save-modal-message" class="modal-message" style="display: none;"></div>
        
        <div class="save-form">
          <div class="form-group">
            <label for="save-title-input">标题：</label>
            <input type="text" id="save-title-input" placeholder="请输入保存标题" maxlength="50">
            <div class="error-message" id="save-title-error"></div>
          </div>
          <div class="form-actions">
            <button id="confirm-save-btn" class="btn primary">保存</button>
            <button id="cancel-save-btn" class="btn secondary">取消</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 设置面板 -->
    <div id="settings-panel" class="settings-panel">
      <div class="settings-content">
        <div class="settings-header">
          <h3>设置</h3>
        </div>
        <div class="settings-body">
          <div class="setting-group">
            <label for="max-items-input">最大保存条数：</label>
            <input type="number" id="max-items-input" min="1" max="50" value="10">
            <div class="setting-desc">最多可保存的JSON数据条数（1-50）</div>
            <div class="error-message" id="max-items-error"></div>
          </div>
          
          <div class="setting-group">
            <label for="expiration-days-input">过期时间（天）：</label>
            <input type="number" id="expiration-days-input" min="1" max="365" value="5">
            <div class="setting-desc">数据保存的有效天数（1-365）</div>
            <div class="error-message" id="expiration-days-error"></div>
          </div>
          
          <div class="setting-group">
            <label>存储信息：</label>
            <div class="storage-info">
              <div class="info-item">
                <span class="info-label">已保存：</span>
                <span id="current-items-count">0/10</span>
              </div>
              <div class="info-item">
                <span class="info-label">过期时间：</span>
                <span id="expiration-info">5天</span>
              </div>
              <div class="info-item">
                <span class="info-label">最旧数据：</span>
                <span id="oldest-item-date">无数据</span>
              </div>
            </div>
          </div>
          
          <div class="setting-group danger-zone">
            <label>危险操作：</label>
            <button id="clear-all-data-btn" class="btn danger">清除所有数据</button>
            <div class="setting-desc">此操作将删除所有保存的JSON数据，不可恢复</div>
          </div>
        </div>
        
        <div class="settings-footer">
          <button id="save-settings-btn" class="btn primary">保存设置</button>
          <button id="reset-settings-btn" class="btn secondary">重置</button>
          <button id="cancel-settings-btn" class="btn secondary">取消</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 工具模块 -->
  <script src="src/js/json-utils.js"></script>
  <script src="src/js/theme-manager.js"></script>
  <script src="src/js/font-manager.js"></script>
  <script src="src/js/share-manager.js"></script>

  <script src="src/js/performance-optimizer.js"></script>
  
  <!-- 浏览器原生API服务模块 -->
  <script src="src/js/browser-native-api.js"></script>
  <script src="src/js/indexeddb-api-service.js"></script>
  <script src="src/js/memory-api-service.js"></script>
  <script src="src/js/unified-api-manager.js"></script>
  
  <script src="src/js/api-handler.js"></script>
  <script src="src/js/line-numbers.js"></script>
  <script src="src/js/format-converter.js"></script>
  <script src="src/js/icon-manager.js"></script>
  
  <!-- 新增模块 -->
  <script src="src/js/data-manager.js"></script>
  <script src="src/js/settings-manager.js"></script>
  <script src="src/js/history-manager.js"></script>
  
  <!-- 主应用脚本 -->
  <script src="src/js/popup.js"></script>
  
  <!-- 浏览器原生API适配补丁 -->
  <script src="src/js/browser-native-api-patch.js"></script>
  
  <!-- Service Worker API专用工具 -->
  <script src="src/js/service-worker-api-utils.js"></script>
</body>
</html>